<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<title>Painel – Britos Barbearia</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
body{font-family:Arial,Helvetica,sans-serif;background:#0b0b0b;color:#eee;margin:0}
.header{display:flex;align-items:center;gap:12px;padding:12px 18px;background:#111}
.logo{height:48px}
.title{font-size:20px}
.main{display:flex;gap:16px;padding:16px}
.column{flex:1;background:#101010;padding:12px;border-radius:8px;min-height:300px}
.customer{border:1px solid #222;padding:8px;margin:8px 0;border-radius:6px;background:#0b0b0b}
.controls{display:flex;gap:8px;flex-wrap:wrap}
.topbar{display:flex;gap:12px;align-items:center;padding:12px}
.small{font-size:13px;color:#bbb}
.stats{margin-top:8px;color:#ccc}
button{background:#222;color:#fff;border:0;padding:8px 10px;border-radius:6px;cursor:pointer}
.callbtn{background:#0a8}
.removebtn{background:#b33}
.play{background:#286}
.loginbox{max-width:420px;margin:50px auto;padding:20px;background:#0f0f0f;border-radius:8px}
input,select{padding:8px;border-radius:6px;border:1px solid #222;background:#0b0b0b;color:#fff;width:100%;margin:6px 0}
</style>
</head>
<body>

<div class="header">
<img src="/images/logo.png" class="logo" alt="logo">
<div class="title">Painel de Controle – Britos Barbearia</div>
</div>

<div id="login" class="loginbox">
<h3>Login</h3>
<input id="user" placeholder="Usuário">
<input id="pass" placeholder="Senha" type="password">
<button id="btnLogin">Entrar</button>
<div class="small">Usuário padrão: <b>barbeiro</b> / Senha: <b>12345</b></div>
</div>

<div id="app" style="display:none">
<div class="topbar">
<div class="controls">
<button onclick="carregar()">Recarregar</button>
<button onclick="chamarProximo()" class="play">Chamar próximo Breno</button>
<label class="small">Tempo médio (min)</label>
<input id="avgGlobal" type="number" value="45" style="width:80px">
</div>

<div style="margin-left:auto" class="stats">
Atendidos hoje: <span id="atendidos">0</span> • Na fila: <span id="nofila">0</span>
</div>
</div>

<div class="main">
<div class="column" style="flex:1 1 100%">
<h4>Fila — Barbeiro Breno</h4>
<div id="col-breno"></div>
</div>
</div>
</div>

<audio id="som">
<source src="" type="audio/wav">
</audio>

<script>
// ====== LOGIN ======
document.getElementById('btnLogin').onclick = ()=>{
  const u = document.getElementById('user').value;
  const p = document.getElementById('pass').value;
  if(u==='barbeiro' && p==='12345'){
    document.getElementById('login').style.display='none';
    document.getElementById('app').style.display='block';
    carregar();
  } else alert('Credenciais incorretas');
};

// ====== CARREGAR FILA ======
async function carregar(){
  const r = await fetch('/api/fila');
  const data = await r.json();
  const br = data.queues.breno || [];

  // adiciona flags se não existirem
  br.forEach(c => {
    if (c.notificado10 === undefined) c.notificado10 = false;
    if (c.notificado5 === undefined) c.notificado5 = false;
  });

  document.getElementById('col-breno').innerHTML =
    br.map((c,i)=>renderItem(c,'breno',i)).join('');

  document.getElementById('atendidos').textContent = data.stats.atendidos || 0;
  document.getElementById('nofila').textContent = br.length;

  filaCache = br; // salva localmente para notificações
}

// ====== RENDER ITEM ======
function renderItem(c, barber, i) {
  const FIX_MIN = 45;
  const esperaMin = (i + 1) * FIX_MIN;

  const previsto = new Date(Date.now() + esperaMin * 60000)
    .toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

  return `
    <div class="customer">
      <div><b>${c.nome}</b> <span class="small">(${c.telefone})</span></div>

      <div class="small">Entrou: ${new Date(c.ts).toLocaleTimeString([], {
        hour:'2-digit', minute:'2-digit'
      })}</div>

      <div class="small">Espera: ${esperaMin} min</div>
      <div class="small">Previsto: ${previsto}</div>

      <div style="margin-top:8px">
        <button class="callbtn" onclick="chamar('${barber}',${i})">Chamar</button>
        <button class="removebtn" onclick="remover('${barber}',${i})">Remover</button>
      </div>
    </div>
  `;
}

// ====== FUNÇÃO PARA ENVIAR WHATSAPP ======
function enviarWhatsApp(tel, msg) {
  window.open(`https://wa.me/55${tel}?text=${encodeURIComponent(msg)}`, '_blank');
}

// ====== NOTIFICAÇÃO AUTOMÁTICA 10 E 5 MIN ======
let filaCache = [];

setInterval(() => {
  if (!filaCache.length) return;

  const agora = Date.now();
  const FIX_MIN = 45;

  filaCache.forEach((c, i) => {
    const esperaMin = (i + 1) * FIX_MIN;
    const tempoRestante = esperaMin * 60000 - (agora - c.ts);

    // 10 minutos
    if (tempoRestante <= 600000 && tempoRestante > 540000 && !c.notificado10) {
      c.notificado10 = true;
      enviarWhatsApp(c.telefone,
        `Olá ${c.nome}, falta aproximadamente 10 minutos para sua vez na Britos Barbearia!`);
    }

    // 5 minutos
    if (tempoRestante <= 300000 && tempoRestante > 240000 && !c.notificado5) {
      c.notificado5 = true;
      enviarWhatsApp(c.telefone,
        `Olá ${c.nome}, está quase na sua vez! Faltam cerca de 5 minutos.`);
    }
  });
}, 30000); // verifica a cada 30 segundos

// ====== CHAMAR CLIENTE ======
async function chamar(barber, index) {
  const res = await fetch('/api/call', {
    method: 'POST',
    headers: { 'content-type': 'application/json' },
    body: JSON.stringify({ barber, index })
  });

  const data = await res.json();

  if (data && data.cliente) {
    playSound();

    const tel = data.cliente.telefone;
    const msg = encodeURIComponent(
      `Olá ${data.cliente.nome}, sua vez chegou na Britos Barbearia. Pode vir agora!`
    );

    window.open(`https://wa.me/55${tel}?text=${msg}`, '_blank');

    setTimeout(() => carregar(), 500);
  } else {
    alert('Erro ao chamar cliente');
  }
}


// ====== REMOVER ======
async function remover(barber,index){
  await fetch(`/api/fila?barber=${barber}&index=${index}`,{method:'DELETE'});
  carregar();
}

// ====== CHAMAR PRÓXIMO ======
async function chamarProximo(){
  await chamar('breno',0);
}

// ====== SOM ======
function playSound(){
  try{
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.type='sine';
    o.frequency.value = 880;
    o.connect(g); g.connect(ctx.destination);
    o.start();
    g.gain.setValueAtTime(0.0001, ctx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.2, ctx.currentTime + 0.01);
    g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.8);
    setTimeout(()=>{ o.stop(); ctx.close(); },900);
  }catch(e){}
}

</script>
</body>
</html>
